name: Horizon Collector

on:
  schedule:
    # 23:30 America/Los_Angeles ~= 07:30 UTC (DST may shift by 1 hour)
    - cron: "30 7 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  collect:
    runs-on: ubuntu-latest
    env:
      # Supported values: repo, s3, gcs
      PERSIST_MODE: repo
      OUTPUT_CSV: Data/Metadata/shorts_metadata_horizon.csv
      OUTPUT_DB: Data/Metadata/horizon_labels.sqlite
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install collector deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install requests

      - name: Write credentials.py from secret
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        run: |
          if [ -z "$YOUTUBE_API_KEY" ]; then
            echo "YOUTUBE_API_KEY secret is missing"
            exit 1
          fi
          cat > credentials.py <<PY
          YOUTUBE_API_KEY = "${YOUTUBE_API_KEY}"
          PY

      - name: Run daily horizon collector
        run: |
          python Data/Metadata/daily_horizon_collector.py --channel-median-sample 0

      - name: Commit output updates to repo
        if: env.PERSIST_MODE == 'repo'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "$OUTPUT_CSV"
          git add "$OUTPUT_DB"

          if git diff --cached --quiet; then
            echo "No output changes to commit"
            exit 0
          fi

          git commit -m "chore: nightly horizon metadata collection"
          git push

      - name: Configure AWS credentials
        if: env.PERSIST_MODE == 's3'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload outputs to S3
        if: env.PERSIST_MODE == 's3'
        env:
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
        run: |
          if [ -z "$S3_BUCKET" ]; then
            echo "S3_BUCKET secret is missing"
            exit 1
          fi
          aws s3 cp "$OUTPUT_CSV" "s3://$S3_BUCKET/metadata/shorts_metadata_horizon.csv"
          aws s3 cp "$OUTPUT_DB" "s3://$S3_BUCKET/metadata/horizon_labels.sqlite"

      - name: Authenticate to GCP
        if: env.PERSIST_MODE == 'gcs'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_JSON }}

      - name: Setup gcloud
        if: env.PERSIST_MODE == 'gcs'
        uses: google-github-actions/setup-gcloud@v2

      - name: Upload outputs to GCS
        if: env.PERSIST_MODE == 'gcs'
        env:
          GCS_BUCKET: ${{ secrets.GCS_BUCKET }}
        run: |
          if [ -z "$GCS_BUCKET" ]; then
            echo "GCS_BUCKET secret is missing"
            exit 1
          fi
          gcloud storage cp "$OUTPUT_CSV" "gs://$GCS_BUCKET/metadata/shorts_metadata_horizon.csv"
          gcloud storage cp "$OUTPUT_DB" "gs://$GCS_BUCKET/metadata/horizon_labels.sqlite"
